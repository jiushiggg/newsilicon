//#include "system.h"
#include "delay.h"
#include <string.h>
#include "mini_fs.h"
//#include "public_temp.h"
//#include "epd.h"
//#include "display_id.h"
//#include "isr.h"

#ifdef LTP_EPD_WF_213
#if 0

const UINT8 lut_vcom0[] =
{
  0x8A,0x8A,0x14,0x4A,0x4A,0x14,0x8F,0x45,0x14,0xB7,0x77,0x19,0x85,0x4F,0x14
};	
const char  lut_w[] =
{
  0x4A,0x4A,0x14,0x8A,0x8A,0x14,0x4F,0x45,0x14,0x77,0xB7,0x19,0x85,0x8F,0x14
};	
const char  lut_b[] =
{
  0x4A,0x4A,0x14,0x8A,0x8A,0x14,0x8F,0x85,0x14,0x77,0xB7,0x19,0x45,0x4F,0x14
};	
const char  lut_g1[] =
{
  0x4A,0x4A,0x14,0x8A,0x8A,0x14,0x8F,0x85,0x14,0x77,0xB7,0x19,0x45,0x4F,0x14
};	
const char  lut_g2[] =
{
  0x4A,0x4A,0x14,0x8A,0x8A,0x14,0x8F,0x85,0x14,0x77,0xB7,0x19,0x45,0x4F,0x14
};			
#else
const UINT8 lut_vcom0[] =
{
0x85,0x85,0x14,0x45,0x45,0x14,0x87,0x42,0x14,0xB7,0x77,0x10,0x82,0x47,0x14
};	
const UINT8 lut_w[] =
{
0x45,0x45,0x14,0x85,0x85,0x14,0x47,0x42,0x14,0x77,0xB7,0x10,0x82,0x87,0x14
};	
const UINT8 lut_b[] =
{
0x45,0x45,0x14,0x85,0x85,0x14,0x87,0x82,0x14,0x77,0xB7,0x10,0x42,0x47,0x14
};	
const UINT8 lut_g1[] =
{
0x45,0x45,0x14,0x85,0x85,0x14,0x87,0x82,0x14,0x77,0xB7,0x10,0x42,0x47,0x14
};	
const UINT8 lut_g2[] =
{
0x45,0x45,0x14,0x85,0x85,0x14,0x87,0x82,0x14,0x77,0xB7,0x10,0x42,0x47,0x14
};	
#endif

//-------------------
static void SPI_Delay(UINT8 xrate)
{
  ;
}

static void send_2byte(UINT8 val) {
  int i;
  union map{
    UINT16 B;
    struct {
      UINT8 L;
      UINT8 H;
    };
  }D = {
    .B = 0,
  };
  
  for (i = 7; i >= 0; i--) {
    if (val & (1 << i))
      D.B |= (3 << (i *2));
  }
  
  SPI_Write(D.H);
  SPI_Write(D.L);
}
static void SPI_Write(UINT8 value){                                                           
  UINT8 i;
  
  
  SPI_Delay(1);
  for(i = 0; i < 8; i++)
  {
    EPD_W21_CLK_0;
    SPI_Delay(2);
    
    if(value & 0x80)
      EPD_W21_MOSI_1;
    else
      EPD_W21_MOSI_0;		
    value = (value << 1); 	
    SPI_Delay(2);
    __NOP();
    __NOP();
    EPD_W21_CLK_1; 
    SPI_Delay(2);
  }
}



static void EPD_W21_WriteCMD(UINT8 command){
  
  SPI_Delay(1);
  EPD_W21_CS_0;                   
  EPD_W21_DC_0;		// command write
  SPI_Write(command);
  EPD_W21_CS_1;
}
static void EPD_W21_WriteDATA(UINT8 command)
{
  
  SPI_Delay(1);
  EPD_W21_CS_0;                   
  EPD_W21_DC_1;		// command write
  SPI_Write(command);
  EPD_W21_CS_1;
}
static void EPD_W21_WriteDATA_led(UINT8 command)
{
  
  SPI_Delay(1);
  EPD_W21_CS_0;                   
  EPD_W21_DC_1;		// command write
  send_2byte(command);
  EPD_W21_CS_1;
}
static UINT8 EPD_W21_ReadDATA(void)
{
  
  UINT8 i,j; 
  
  P2OUT &= ~BIT3; 
  P2DIR &= ~BIT3; 
  
  EPD_W21_CS_0; 
  EPD_W21_DC_1;	 // command write 
  j=0; 
  SPI_Delay(2); 
  for(i=0; i<8; i++) 
  { 
    EPD_W21_CLK_0; 
    SPI_Delay(20); 
    j=(j<<1); 
    if((P2IN &BIT3)==BIT3) 
      j|=0x01; 
    else 
      j&=0xfe;	
    SPI_Delay(5); 
    
    EPD_W21_CLK_1; 
    SPI_Delay(5); 
  } 
  EPD_W21_CS_1; 
  
  P2DIR |=BIT3; 
  return(j); 
}
extern void wakeup_wait(UINT16 tm);
static void lcd_chkstatus(void)
{
  
#define WAIT_COUNT	90	//160s超时
  SetWathcDog();
  UINT8 busy,i=WAIT_COUNT;
  
  SetISR_RFException(FALSE, 0,0); 
  
  do
  {
    wakeup_wait(400);
    EPD_W21_WriteCMD(0x71);    
    busy = EPD_W21_ReadDATA(); 	   	
    busy =!(busy & 0x01);  	 
    i--;
  }
  while(busy && (0 != i) ); 
  SetISR_RFException(FALSE, 0,0); 
  gEventFlag &= ~EVENT_FLAG_LTIMER;		//在中断置位，需清除。
  // P3OUT ^= BIT2;//debug 
  if(i == 0)
    while(1);
  
}

static UINT8 display_data_reversal(UINT8 temp1)
{
  UINT8 retvalue =0,i=0;
  retvalue |= (temp1 &1);
  
  for(i=1;i<8;i++)
  {
    retvalue <<= 1;
    retvalue |=(((1<<i) & temp1) >>i);
  }
  
  return retvalue;
}
//----------------------
#if 0
void display_id_213(UINT8  buff[],UINT8 lengh) {
  
  
  UINT16 pcnt;
  UINT8 i, m=0,k=0;
  UINT8 row_temp=0;
  
  
  m=ret_dis_num(buff[0]);
  
  for (pcnt = 0; pcnt < 212; pcnt++) 
  {	         
    for (i = 0; i < 13; i++){
      
      if(i>10&&k<lengh ){
        EPD_W21_WriteDATA_led((Bmp[m][row_temp]));
        row_temp+=1;
      }
      
      else
        EPD_W21_WriteDATA_led(0xff);
    }
    if(pcnt%8 ==0 && k<lengh){
      row_temp=0;
      m=ret_dis_num(buff[k]);
      k+=1;
    }
  }
  
  
  
}
#endif 
const unsigned char gImage_1[2756] = { /* 0X01,0X01,0XD4,0X00,0X68,0X00, */
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XD1,
  0XDE,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X99,0X5F,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XD9,0XBF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XE4,0X7E,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0X8D,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XE8,0XDF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XED,0X1F,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XBD,0X7E,0X00,0X00,0X0F,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XC1,0XBE,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XED,0XBF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X00,0X7F,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XF8,0X00,0X0F,0XFF,0XCF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XF0,0X00,0X07,0XFF,0XF3,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XE0,0X00,0X03,0XFF,0XFC,0XFE,0X00,0X00,0X0F,0XFF,0XFF,0XFF,
  0XFF,0XC0,0XFF,0X81,0XFF,0XFF,0X3E,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XC3,0XFF,
  0XE1,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XC3,0XFF,0XE1,0XFF,0XFB,
  0X1E,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XC3,0XFF,0XE1,0XFF,0XDB,0XDE,0X00,0X00,
  0X0F,0XFF,0XFF,0XFF,0XFF,0XC3,0XFF,0XE1,0XFF,0XDB,0XDE,0X00,0X00,0X0F,0XFF,0XFF,
  0XFF,0XFF,0XC0,0XFF,0X81,0XFF,0XD8,0X3F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XE0,
  0X00,0X03,0XFF,0XDB,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XF0,0X00,0X07,0XFF,
  0XDB,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XF8,0X00,0X0F,0XFF,0XD8,0X7E,0X00,
  0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XFF,0X00,0X3F,0XFF,0XDB,0XBE,0X00,0X00,0X0F,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFB,0XDE,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFB,0XDF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,
  0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XC0,0X00,
  0X01,0XFF,0XFF,0XFE,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XC0,0X00,0X01,0XFF,0XFF,
  0XFE,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XC0,0X00,0X01,0XFF,0XFF,0XFE,0X00,0X00,
  0X0F,0XFF,0XFF,0XFF,0XFF,0XE0,0X00,0X01,0XFF,0XFF,0XFE,0X00,0X00,0X0F,0XFF,0XFF,
  0XFF,0XFF,0XF0,0XFF,0XFF,0XFF,0XFF,0XFE,0X00,0X00,0X0F,0XFF,0XFE,0XF7,0XFF,0XF8,
  0X7F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X62,0XF3,0XFF,0XFC,0X3F,0XFF,0XFF,
  0XFF,0XFE,0X00,0X00,0X0F,0XFF,0X7A,0XF7,0XFF,0XFC,0X3F,0XFF,0XFF,0XFE,0X1E,0X00,
  0X00,0X0F,0XFE,0X7A,0X6F,0XFF,0XFE,0X1F,0XFF,0XFF,0XFE,0X1E,0X00,0X00,0X0F,0XFD,
  0X76,0XAF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X1F,0XFF,0XFF,0XFF,0XFF,0X6E,0XDF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFE,0X1F,0XFF,0XFF,0XFF,0XFF,0X9E,0XBF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFC,0X38,0X6F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,
  0X00,0X00,0X0F,0XFF,0XB6,0XF7,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X00,0X00,0X0F,
  0XFF,0XBE,0XFB,0XFF,0XFF,0XFF,0XFF,0XC0,0X3F,0XFE,0X00,0X00,0X0F,0XFF,0XBE,0X03,
  0XFF,0XFF,0XFF,0XFE,0X00,0X07,0XFF,0XFF,0XFF,0XFF,0XFC,0XFE,0XBF,0XFF,0XE0,0X1F,
  0XFC,0X00,0X01,0XFF,0XFF,0XFF,0XFF,0XFF,0X02,0XDF,0XFF,0XE0,0X1F,0XF0,0X00,0X00,
  0XFE,0X00,0X00,0X0F,0XFF,0XBE,0XDF,0XFF,0XE0,0X1F,0XE0,0X00,0X00,0X7F,0XFF,0XFF,
  0XFF,0XFF,0XDE,0XEF,0XFF,0XE0,0X1F,0XE0,0X00,0X00,0X3F,0XFF,0XFF,0XFF,0XFF,0XEE,
  0XEF,0XFF,0XE0,0X1F,0XC0,0X00,0X00,0X3E,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XE0,
  0X1F,0XC0,0X1F,0XC0,0X1F,0XFF,0XFF,0XFF,0XFF,0XF7,0XE7,0XFF,0XE0,0X1F,0X80,0X3F,
  0XE0,0X1F,0XFF,0XFF,0XFF,0XFF,0XF0,0XDB,0XFF,0XE0,0X1F,0X80,0X7F,0XF0,0X0E,0X00,
  0X00,0X0F,0XFF,0XF7,0X5B,0XFF,0XE0,0X1F,0X80,0XFF,0XF8,0X0F,0XFF,0XFF,0XFF,0XFF,
  0XF7,0X5B,0XFF,0XE0,0X1F,0X80,0XFF,0XF8,0X0F,0XFF,0XFF,0XFF,0XFF,0XF7,0X5B,0XFF,
  0XE0,0X1F,0X80,0XFF,0XF8,0X0F,0XFF,0XFF,0XFF,0XFF,0XF7,0X5B,0XFF,0XE0,0X1F,0X80,
  0XFF,0XF8,0X0E,0X00,0X00,0X0F,0XFF,0XF8,0XAB,0XFF,0XE0,0X0F,0XC0,0XFF,0XF8,0X0E,
  0X00,0X00,0X0F,0XFF,0XFF,0XE7,0XFF,0XE0,0X00,0X40,0X7F,0XF0,0X0E,0X00,0X00,0X0F,
  0XFF,0XFF,0XFF,0XFF,0XE0,0X00,0X00,0X7F,0XE0,0X1F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XE0,0X00,0X00,0X3F,0X80,0X1F,0XFF,0XFF,0XFF,0XFF,0XC0,0X7F,0XFF,0XE0,0X00,
  0X00,0X1E,0X00,0X1F,0XFF,0XFF,0XFF,0XFF,0X3F,0X9F,0XFF,0XE0,0X00,0X00,0X1E,0X00,
  0X3E,0X00,0X00,0X0F,0XFE,0XFF,0XEF,0XFF,0XFC,0X00,0X00,0X1E,0X00,0X7E,0X00,0X00,
  0X0F,0XFE,0XFF,0XEF,0XFF,0XFF,0XF0,0X00,0X3E,0X00,0XFF,0XFF,0XFF,0XFF,0XFE,0XFF,
  0XEF,0XFF,0XFF,0XFF,0X80,0X3F,0X01,0XFE,0X00,0X00,0X0F,0XFE,0XFF,0XEF,0XFF,0XFF,
  0XFF,0XFE,0X3F,0X07,0XFE,0X00,0X00,0X0F,0XFF,0X3F,0X9F,0XFF,0XFF,0XFF,0XFF,0XFF,
  0X1F,0XFE,0X00,0X00,0X0F,0XFF,0XC0,0X7F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X00,
  0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X00,0X00,0X0F,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X0F,0X8F,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XF3,0XEF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,
  0X00,0X00,0X0F,0XFE,0XFD,0XEF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFE,0XFE,0XEF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XFF,0X6F,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X00,0X00,0X0F,0XFE,0XFF,0XAF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFE,0X00,0X00,0X0F,0XFF,0X1F,0XCF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFE,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XEF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFE,0X00,0X00,0X0F,0XFF,0XFF,0XEF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X00,
  0X00,0X0F,0XFE,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X00,0X00,0X0F,0XFF,
  0X7F,0XEF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X7F,0XEF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFE,0X00,0X00,0X0F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X83,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFB,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFE,0X00,0X00,0X0F,0XFF,0X00,0XFB,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0X7F,0X7B,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X7F,
  0XBB,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X00,0X00,0X0F,0XFF,0X7F,0X7B,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X60,0XFB,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X6E,0XFB,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0X6E,0XFB,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0X6E,0XFB,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X6E,0XFB,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFC,0X6E,0XFB,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X80,0X07,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XEF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XF7,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFB,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFE,0XDF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFC,0X80,
  0X03,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XDF,0XF7,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XDF,0XF7,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XDF,0XF7,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFE,0XDF,0XF7,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,
  0XC0,0X07,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XDB,0X77,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X4F,0XFE,0X5B,0X77,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFD,0XB7,0XFE,0X80,0X07,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFD,0XB7,0XFE,0XDF,0XF7,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X4F,
  0XFE,0XDF,0XF7,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XDF,0XF7,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X4F,0XFE,0XC0,0X03,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFD,0XB7,0XFE,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XDF,
  0XFF,0XFF,0XFD,0XB7,0XFE,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XDF,0XFF,0XFF,0XFE,
  0XEF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X8F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X8F,0XFF,0XFF,0XFE,0X0F,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0X57,0XFF,0XFF,0XFD,0XF7,0XFF,0XC7,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XDF,0XFF,0XFF,0XFD,0XF7,0XFE,0XF4,0X03,0XFF,0XFF,0XFF,0XFF,0XFF,0XDF,0XFF,0XFF,
  0XFE,0X0F,0XFE,0XF5,0XB7,0XFF,0XFF,0XFF,0XFF,0XFF,0XDF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0X75,0XB7,0XFF,0XFF,0XFF,0XFF,0XFF,0XDF,0XFF,0XFF,0XFF,0XF7,0XFF,0X75,0XB7,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XDF,0XFF,0XFF,0XFC,0X07,0XFF,0XB5,0XB7,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XDF,0XFF,0XFF,0XFE,0XF7,0XFF,0XB5,0XB7,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFC,0X0C,0X03,0XFF,0XFF,0XFF,0XFF,0XFF,0XDF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XDF,0XFF,0XFF,0XFE,0X4F,0XFF,0XBF,0XFF,
  0XF8,0X3F,0XFF,0XFF,0XFF,0XA0,0XFF,0XFF,0XFD,0XB7,0XFF,0XB7,0XFF,0XF6,0XDF,0XFF,
  0XFF,0XFF,0X7F,0XFF,0XFF,0XFD,0XB7,0XFF,0XBB,0XFF,0XF6,0XDF,0XC3,0XFF,0XFC,0XFF,
  0XFF,0XFF,0XFE,0X4F,0XFC,0X00,0X07,0XF9,0XBF,0X3C,0XFF,0XFF,0X61,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XBD,0XFB,0XFF,0XFE,0XFF,0X7F,0XFF,0XBE,0XFF,0XFF,0XFF,0XF7,0XFF,0XBE,
  0XF7,0XFB,0X3F,0XFF,0XFF,0XFC,0XDF,0XFF,0XFF,0XFC,0X07,0XFF,0XBE,0XFF,0XF6,0XDF,
  0XFF,0XFF,0XFF,0X00,0XFF,0XFF,0XFE,0XF7,0XFF,0XFF,0XFF,0XF6,0XDF,0XFF,0XFF,0XFF,
  0XBF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XF8,0X3F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XB9,0XFF,0XFE,0XAB,0XFF,0XFF,0XFE,0XCF,0XFF,
  0XFE,0XFF,0XF3,0XFF,0XB6,0XFF,0XFE,0XA8,0XFF,0XFF,0XFD,0XB7,0XFF,0XFC,0XFF,0XF4,
  0XFF,0XB6,0XFF,0XFE,0XAA,0XFF,0XFF,0XFD,0XB7,0XFE,0XEE,0XFF,0XF7,0X1F,0XCE,0XFF,
  0XFC,0X02,0XFF,0XFF,0XFE,0X0F,0XFC,0XCE,0XFF,0XF7,0XFF,0XFF,0XFF,0XFE,0XAA,0XFF,
  0XFF,0XFF,0XFF,0XFE,0XEE,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XAA,0XFF,0XFF,0XFF,0XF7,
  0XFE,0XEE,0XFF,0XF9,0X3F,0XFF,0XFF,0XFE,0XAA,0XFF,0XFF,0XFC,0X07,0XFE,0XEE,0XFF,
  0XF6,0XDF,0XFF,0XFF,0XFC,0X00,0XFF,0XFF,0XFE,0XF7,0XFE,0XEE,0XFF,0XF6,0XDF,0XFF,
  0XFF,0XFF,0X3F,0XFF,0XFF,0XFF,0XFF,0XFF,0X00,0X07,0XFB,0XBE,0XFF,0X7F,0XFF,0XDF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0X6E,0XFB,0XFF,0XFF,0X3C,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,
  0X77,0XFF,0X6E,0XF7,0XF9,0X3F,0XC3,0XFF,0XFF,0X37,0XFF,0XFF,0XFD,0XB7,0XFF,0X6E,
  0XFF,0XF6,0XDF,0XFF,0XFF,0XFD,0X57,0XFF,0XFF,0XFD,0XD7,0XFF,0X6E,0XFF,0XF6,0XDF,
  0XFF,0XFF,0XFD,0X56,0XFF,0XFF,0XFE,0XE7,0XFF,0X6E,0XFF,0XFB,0XBF,0XFF,0XFF,0XFD,
  0X6A,0XFF,0XFF,0XFF,0XFF,0XFF,0X6E,0XFF,0XFF,0XFF,0XFC,0XFF,0XFD,0X68,0XFF,0XFF,
  0XF9,0XFF,0XFF,0XFE,0XFF,0XF8,0X3F,0XE3,0XFF,0XFC,0X12,0XFF,0XFF,0XFE,0X7F,0XFF,
  0XFF,0XFF,0XF7,0XDF,0X9B,0XFF,0XFD,0X6A,0XFF,0XFF,0XFF,0X9F,0XFF,0XFF,0XFF,0XF7,
  0XDF,0XE3,0XFF,0XFD,0X57,0XFF,0XFF,0XFF,0XE7,0XFF,0XFF,0XFF,0XF8,0X3F,0XFC,0XFF,
  0XFD,0X57,0XFF,0XFF,0XFF,0XFF,0XFE,0XFF,0XF3,0XFF,0XFF,0XFF,0XFF,0XFF,0X37,0XFF,
  0XFF,0XFE,0X4F,0XFC,0XC0,0X37,0XF3,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFD,0XB7,
  0XFE,0XDF,0XEF,0XF4,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFD,0XB7,0XFE,0XDF,0XDF,
  0XF7,0X1F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XEF,0XFE,0X50,0X3F,0XF7,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0X9F,0XDF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XF7,0XFE,0XDF,0XEF,0XF9,0XDF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFC,
  0X07,0XFE,0XC0,0X37,0XF6,0XDF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XF7,0XFE,0XBF,
  0XFB,0XF7,0X5F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XA0,0XDB,0XFB,0X9F,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XBE,0XEF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XF9,0XFF,0XFF,0XBE,0XF7,0XF9,0XDF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFE,0X7F,0XFC,0X00,0X07,0XF6,0XDF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0X9F,0XFF,
  0XBE,0XFF,0XF7,0X5F,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XE7,0XFF,0XBE,0XFF,0XFB,
  0X9F,0XFF,0XFD,0X39,0XFE,0XFF,0XB0,0X1F,0XFF,0XFF,0XA0,0XFF,0XFF,0XFF,0XFF,0XFD,
  0X75,0XF2,0X87,0XB7,0XDD,0XCF,0XFF,0XFF,0XFF,0XF9,0XDF,0XE0,0X78,0X55,0XF5,0XAF,
  0XB7,0XDD,0XB7,0XFF,0XFF,0XFF,0XF6,0XDF,0XEE,0XBD,0X53,0XF5,0XAF,0XB0,0X1D,0XB7,
  0XFF,0XFF,0XFF,0XF7,0X5F,0XEE,0XBC,0X57,0XE2,0X87,0X95,0X5C,0X37,0XFF,0XFE,0XFF,
  0XFB,0X9F,0XF1,0XFD,0X53,0XFA,0XFF,0XA0,0X1F,0XFF,0XFE,0XFE,0XFF,0XFF,0XFF,0XFF,
  0XF8,0X55,0XFB,0X7F,0XB7,0XDE,0X0F,0XFE,0XBE,0X83,0XF8,0X3F,0XC1,0XFD,0X75,0XE0,
  0X07,0XB7,0XDD,0XF7,0XFE,0XA2,0XB7,0XF7,0XDF,0XBE,0XFD,0X35,0XFA,0X7F,0XB0,0X1D,
  0XF7,0XFE,0XAA,0XB7,0XF7,0XDF,0XBE,0XFD,0XFF,0XFB,0XBF,0XFF,0XFE,0X0F,0XFE,0XA8,
  0XB7,0XF8,0X3F,0XC1,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFE,0XAA,0X83,0XFF,0XFF,
  0XFF,0XFE,0XFB,0XFE,0XFF,0XEA,0XFF,0XFF,0XFC,0X2A,0XFF,0XF8,0X3F,0XCE,0XFE,0XD7,
  0XFD,0X87,0XEA,0XFF,0XFF,0XFE,0XAA,0X87,0XF6,0XDF,0XB6,0XFE,0XCF,0XFA,0XAF,0X80,
  0X1F,0XFF,0XFE,0XA8,0XBB,0XF6,0XDF,0XBA,0XFE,0XDF,0XF6,0XAF,0XFF,0XFF,0XFF,0XFE,
  0XAA,0XBB,0XF9,0XBF,0XDC,0XFE,0X03,0XEE,0XAF,0X80,0X1F,0XFF,0XFE,0XAA,0X1F,0XFF,
  0XFF,0XFF,0XFE,0XDD,0XF6,0XAF,0XEA,0XFF,0XFF,0XFE,0XA2,0XAF,0XFB,0X3F,0XFE,0XF8,
  0XDD,0XFA,0XAF,0XEA,0XFF,0XFF,0XFE,0XBE,0XB7,0XF6,0XDF,0X80,0XFE,0X4F,0XFD,0X87,
  0X80,0X3F,0XFF,0XFE,0XFE,0XBB,0XF6,0XDF,0XDE,0XFE,0X97,0XFE,0XFF,0XED,0XDF,0XFF,
  0XFF,0XFE,0XFB,0XF8,0X3F,0XFF,0XFE,0XDB,0XFE,0XFF,0XEE,0XDF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,0XFF,
  0XFF,0XFF,0XFF,0XFF,};

void Ultrachip(UINT8 color)
{
  UINT16 i;		     
  for(i=0;i<2756;i++)	     
  { 
    EPD_W21_WriteDATA_led(gImage_1[i]);  			  
  }                	     	     
}
void display_lcd(file_id_t fd)
{
  UINT16 pcnt;
  UINT8 i;
  UINT8  *data = TEMP.BYTE64,*data_red = TEMP.BYTE64+30;
  for (pcnt = 0; pcnt < 212; pcnt++) 
  {
    f_read(fd, (pcnt) * 13 ,data, 13);  	 
    f_read(F_BMP_RED,(pcnt) * 13 ,data_red, 13);  
    for (i = 0; i < 13; i++)
    {               
      data[12-i] &= data_red[12-i];       
      EPD_W21_WriteDATA_led(display_data_reversal(data[12-i]));
    }
    
  }
  
  
}

/*
void display_lcd_1(file_id_t fd)
{
UINT16 pcnt;
UINT8 i, data[13];
for (pcnt = 0; pcnt < 212; pcnt++) 
{	         
for (i = 0; i < 13; i++){
f_read(fd, 9+(211-pcnt) * 13 ,data, 13);        
EPD_W21_WriteDATA_led(data[i]);
}
}
}*/

void lut_bw(void)
{	 
  unsigned int count;
  EPD_W21_WriteCMD(0x20);
  for(count=0;count<15;count++)	     
  { 
    EPD_W21_WriteDATA(lut_vcom0[count]);  
  }

  EPD_W21_WriteCMD(0x21);
  for(count=0;count<15;count++)	     
  {
    EPD_W21_WriteDATA(lut_w[count]);
  }   

  EPD_W21_WriteCMD(0x22);
  for(count=0;count<15;count++)	     
  {
    EPD_W21_WriteDATA(lut_b[count]);
  } 
  
  EPD_W21_WriteCMD(0x23);
  for(count=0;count<15;count++)	     
  {
    EPD_W21_WriteDATA(lut_g1[count]);
  }    
  
  EPD_W21_WriteCMD(0x24);
  for(count=0;count<15;count++)	     
  {
    EPD_W21_WriteDATA(lut_g2[count]);
  } 
  
  
}


void EPD_W21_Init(void){
  
  SPI_IOInit();
  
  EPD_W21_BS_0;		         // 4 wire spi mode selected
  EPD_W21_RST_0;		 // Module reset
  Delay_ms(100);
  EPD_W21_RST_1;
  Delay_ms(100);
  EPD_W21_WriteCMD(0x01);        //Set VGH VGL   VSH VSL
  EPD_W21_WriteDATA (0x07);	    
  EPD_W21_WriteDATA (0x00);

  EPD_W21_WriteDATA (0x0D);
  EPD_W21_WriteDATA (0x00);
    
  EPD_W21_WriteCMD(0x04);         //power up 

  Delay_ms(500);
  lcd_chkstatus();                //check ic state
  
  EPD_W21_WriteCMD(0x00);         //TCON Setting
  EPD_W21_WriteDATA (0xdf);   
  EPD_W21_WriteCMD(0X50);	  // VCOM AND DATA INTERVAL SETTING (CDI)
  EPD_W21_WriteDATA(0x37);			  
  EPD_W21_WriteCMD(0x30);	  //PLL setting
  EPD_W21_WriteDATA (0x2a);              
  
  EPD_W21_WriteCMD(0x61);	  // resolution setting
  EPD_W21_WriteDATA (0x68);       	 
  EPD_W21_WriteDATA (0x00);		
  EPD_W21_WriteDATA (0xd4);
  
  EPD_W21_WriteCMD(0x82);	  //vcom setting
  EPD_W21_WriteDATA (0x08);  
  lut_bw();
  
  EPD_W21_WriteCMD(0x10);	       //update grey image
  
}
BOOL display_color(UINT8 color_flag)
{
  BOOL flag = FALSE;
  
  switch(color_flag)
  {
  case 0:
    EPD_W21_Init();
    Ultrachip(0xff);
    flag = TRUE;
    break;
  case 1:
    return FALSE;
    break;
  case 2:
    return FALSE;
    break;
  case 3:
    return FALSE;
    break;
  default:
    return FALSE;
    break;
    
  }
  EPD_W21_WriteCMD(0x12);        //display 
  lcd_chkstatus();
  Delay_ms(100);
  EPD_W21_WriteCMD(0x02);		  //power off 
  Delay_ms(300);
  SPI_off();
  return flag;
}

void my_init_epd(BOOL test) {
  EPD_W21_Init();
  display_lcd(F_BMP_BW);
  EPD_W21_WriteCMD(0XE0);		  //cascade setting
  EPD_W21_WriteDATA(0x01);
  EPD_W21_WriteCMD(0x12);                 //display 
  lcd_chkstatus();
  SetWathcDog();
  
  Delay_ms(100);
  EPD_W21_WriteCMD(0x82);  
  EPD_W21_WriteCMD(0x00);
  EPD_W21_WriteCMD(0x01);   				//power setting      
  EPD_W21_WriteDATA(0x02); 				//gate switch to external
  EPD_W21_WriteDATA(0x00);
  EPD_W21_WriteDATA(0x00); 
  EPD_W21_WriteDATA(0x00); 
 
  Delay_ms(1500);
  SetWathcDog();
  EPD_W21_WriteCMD(0x02);		   //power off  
  Delay_ms(1500);
  SPI_off();
}

void Init_EPD(void) {
  my_init_epd(FALSE);
  gEventFlag &= ~EVENT_FLAG_DISPLAYID;
}

#endif


